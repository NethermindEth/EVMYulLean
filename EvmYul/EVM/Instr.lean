import EvmYul.Operations

namespace EvmYul

namespace EVM

open Operation

def serializeStopArithInstr : SAOp .EVM → UInt8
  | .STOP => 0
  | .ADD  => 1
  | .MUL  => 2
  | .SUB  => 3
  | .DIV  => 4
  | .SDIV => 5
  | .MOD  => 6
  | .SMOD => 7
  | .ADDMOD => 8
  | .MULMOD => 9
  | .EXP => 10
  | .SIGNEXTEND => 11

def serializeCompBitInstr : CBLOp .EVM → UInt8
  | .LT => 16
  | .GT => 17
  | .SLT => 18
  | .SGT => 19
  | .EQ => 20
  | .ISZERO => 21
  | .AND => 22
  | .OR => 23
  | .XOR => 24
  | .NOT => 25
  | .BYTE => 26
  | .SHL => 27
  | .SHR => 28
  | .SAR => 29

def serializeKeccakInstr : KOp .EVM → UInt8
  | .KECCAK256 => 32

def serializeEnvInstr : EOp .EVM → UInt8
  | .ADDRESS => 48
  | .BALANCE => 49
  | .ORIGIN => 50
  | .CALLER => 51
  | .CALLVALUE => 52
  | .CALLDATALOAD => 53
  | .CALLDATASIZE => 54
  | .CALLDATACOPY => 55
  | .CODESIZE => 56
  | .CODECOPY => 57
  | .GASPRICE => 58
  | .EXTCODESIZE => 59
  | .EXTCODECOPY => 60
  | .RETURNDATASIZE => 61
  | .RETURNDATACOPY => 62
  | .EXTCODEHASH => 63

def serializeBlockInstr : BOp .EVM → UInt8
  | .BLOCKHASH => 64
  | .COINBASE => 65
  | .TIMESTAMP => 66
  | .NUMBER => 67
  | .PREVRANDAO => 68
  | .DIFFICULTY => 68
  | .GASLIMIT => 69
  | .CHAINID => 70
  | .SELFBALANCE => 71
  | .BASEFEE => 72

def serializeStackMemFlowInstr : SMSFOp .EVM → UInt8
  | .POP => 80
  | .MLOAD => 81
  | .MSTORE => 82
  | .MSTORE8 => 83
  | .SLOAD => 84
  | .SSTORE => 85
  | .PC => 88
  | .MSIZE => 89
  | .GAS => 90
  | .JUMP => 86
  | .JUMPI => 87
  | .JUMPDEST => 91
  | .TLOAD => 0x5c
  | .TSTORE => 0x5d
  | .MCOPY => 0x5E

def serializePushInstr : POp → UInt8
  | .PUSH0 => 95
  | .PUSH1 => 96
  | .PUSH2 => 97
  | .PUSH3 => 98
  | .PUSH4 => 99
  | .PUSH5 => 100
  | .PUSH6 => 101
  | .PUSH7 => 102
  | .PUSH8 => 103
  | .PUSH9 => 104
  | .PUSH10 => 105
  | .PUSH11 => 106
  | .PUSH12 => 107
  | .PUSH13 => 108
  | .PUSH14 => 109
  | .PUSH15 => 110
  | .PUSH16 => 111
  | .PUSH17 => 112
  | .PUSH18 => 113
  | .PUSH19 => 114
  | .PUSH20 => 115
  | .PUSH21 => 116
  | .PUSH22 => 117
  | .PUSH23 => 118
  | .PUSH24 => 119
  | .PUSH25 => 120
  | .PUSH26 => 121
  | .PUSH27 => 122
  | .PUSH28 => 123
  | .PUSH29 => 124
  | .PUSH30 => 125
  | .PUSH31 => 126
  | .PUSH32 => 127

def serializeDupInstr : DOp → UInt8
  | .DUP1 => 128
  | .DUP2 => 129
  | .DUP3 => 130
  | .DUP4 => 131
  | .DUP5 => 132
  | .DUP6 => 133
  | .DUP7 => 134
  | .DUP8 => 135
  | .DUP9 => 136
  | .DUP10 => 137
  | .DUP11 => 138
  | .DUP12 => 139
  | .DUP13 => 140
  | .DUP14 => 141
  | .DUP15 => 142
  | .DUP16 => 143

def serializeSwapInstr : ExOp → UInt8
  | .SWAP1 => 144
  | .SWAP2 => 145
  | .SWAP3 => 146
  | .SWAP4 => 147
  | .SWAP5 => 148
  | .SWAP6 => 149
  | .SWAP7 => 150
  | .SWAP8 => 151
  | .SWAP9 => 152
  | .SWAP10 => 153
  | .SWAP11 => 154
  | .SWAP12 => 155
  | .SWAP13 => 156
  | .SWAP14 => 157
  | .SWAP15 => 158
  | .SWAP16 => 159

def serializeLogInstr : LOp .EVM → UInt8
  | .LOG0 => 160
  | .LOG1 => 161
  | .LOG2 => 162
  | .LOG3 => 163
  | .LOG4 => 164

def serializeSysInstr : SOp .EVM → UInt8
  | .CREATE => 240
  | .CALL => 241
  | .CALLCODE => 242
  | .RETURN => 243
  | .DELEGATECALL => 244
  | .CREATE2 => 245
  | .STATICCALL => 250
  | .REVERT => 253
  | .INVALID => 254
  | .SELFDESTRUCT => 255

def serializeInstr : Operation .EVM → UInt8
  | .StopArith a    => serializeStopArithInstr a
  | .CompBit e      => serializeCompBitInstr e
  | .Keccak k       => serializeKeccakInstr k
  | .Env e          => serializeEnvInstr e
  | .Block b        => serializeBlockInstr b
  | .StackMemFlow m => serializeStackMemFlowInstr m
  | .Push p         => serializePushInstr p
  | .Dup d          => serializeDupInstr d
  | .Exchange e     => serializeSwapInstr e
  | .Log l          => serializeLogInstr l
  | .System s       => serializeSysInstr s

  def δ : Operation .EVM → Option ℕ
    | .STOP => some 0
    | .ADD => some 2
    | .MUL => some 2
    | .SUB => some 2
    | .DIV => some 2
    | .SDIV => some 2
    | .MOD => some 2
    | .SMOD => some 2
    | .ADDMOD => some 3
    | .MULMOD => some 3
    | .EXP => some 2
    | .SIGNEXTEND => some 2
    | .LT => some 2
    | .GT => some 2
    | .SLT => some 2
    | .SGT => some 2
    | .EQ => some 2
    | .ISZERO => some 1
    | .AND => some 2
    | .OR => some 2
    | .XOR => some 2
    | .NOT => some 1
    | .BYTE => some 2
    | .SHL => some 2
    | .SHR => some 2
    | .SAR => some 2
    | .KECCAK256 => some 2
    | .ADDRESS => some 0
    | .BALANCE => some 1
    | .ORIGIN => some 0
    | .CALLER => some 0
    | .CALLVALUE => some 0
    | .CALLDATALOAD => some 1
    | .CALLDATASIZE => some 0
    | .CALLDATACOPY => some 3
    | .CODESIZE => some 0
    | .CODECOPY  => some 3
    | .GASPRICE => some 0
    | .EXTCODESIZE => some 4
    | .EXTCODECOPY => some 4
    | .RETURNDATASIZE => some 0
    | .RETURNDATACOPY => some 3
    | .EXTCODEHASH  => some 1
    | .BLOCKHASH  => some 1
    | .COINBASE => some 0
    | .TIMESTAMP  => some 0
    | .NUMBER => some 0
    | .PREVRANDAO  => some 0
    | .DIFFICULTY => some 0
    | .GASLIMIT => some 0
    | .CHAINID => some 0
    | .SELFBALANCE  => some 0
    | .BASEFEE => some 0
    | .POP => some 1
    | .MLOAD => some 2
    | .MSTORE => some 2
    | .MSTORE8  => some 1
    | .SLOAD  => some 1
    | .SSTORE  => some 2
    | .PC => some 0
    | .MSIZE  => some 0
    | .GAS  => some 0
    | .Push _ => some 0
    | .DUP1 => some 1
    | .DUP2 => some 2
    | .DUP3 => some 3
    | .DUP4 => some 4
    | .DUP5 => some 5
    | .DUP6 => some 6
    | .DUP7 => some 7
    | .DUP8 => some 8
    | .DUP9 => some 9
    | .DUP10 => some 10
    | .DUP11 => some 11
    | .DUP12 => some 12
    | .DUP13 => some 13
    | .DUP14 => some 14
    | .DUP15 => some 15
    | .DUP16 => some 16
    | .SWAP1 => some 2
    | .SWAP2 => some 3
    | .SWAP3 => some 4
    | .SWAP4 => some 5
    | .SWAP5 => some 6
    | .SWAP6 => some 7
    | .SWAP7 => some 8
    | .SWAP8 => some 9
    | .SWAP9 => some 10
    | .SWAP10 => some 11
    | .SWAP11 => some 12
    | .SWAP12 => some 13
    | .SWAP13 => some 14
    | .SWAP14 => some 15
    | .SWAP15 => some 16
    | .SWAP16 => some 17
    | .LOG0 => some 2
    | .LOG1 => some 3
    | .LOG2 => some 4
    | .LOG3 => some 5
    | .LOG4 => some 6
    | .JUMP => some 1
    | .JUMPI => some 2
    | .JUMPDEST => some 0
    | .TLOAD => some 1
    | .TSTORE => some 2
    | .MCOPY => some 3
    | .CREATE => some 3
    | .CALL => some 7
    | .CALLCODE => some 7
    | .RETURN => some 2
    | .DELEGATECALL => some 6
    | .CREATE2 => some 6
    | .STATICCALL => some 6
    | .REVERT => some 2
    | .INVALID => none
    | .SELFDESTRUCT => some 1

  def α : Operation .EVM → Option ℕ
    | .STOP => some 0
    | .ADD => some 1
    | .MUL => some 1
    | .SUB => some 1
    | .DIV => some 1
    | .SDIV => some 1
    | .MOD => some 1
    | .SMOD => some 1
    | .ADDMOD => some 1
    | .MULMOD => some 1
    | .EXP => some 1
    | .SIGNEXTEND  => some 1
    | .LT => some 1
    | .GT => some 1
    | .SLT  => some 1
    | .SGT => some 1
    | .EQ => some 1
    | .ISZERO => some 1
    | .AND => some 1
    | .OR => some 1
    | .XOR => some 1
    | .NOT => some 1
    | .BYTE => some 1
    | .SHL => some 1
    | .SHR => some 1
    | .SAR => some 1
    | .KECCAK256 => some 1
    | .ADDRESS => some 1
    | .BALANCE => some 1
    | .ORIGIN => some 1
    | .CALLER => some 1
    | .CALLVALUE => some 1
    | .CALLDATALOAD  => some 1
    | .CALLDATASIZE => some 1
    | .CALLDATACOPY => some 0
    | .CODESIZE  => some 1
    | .CODECOPY => some 0
    | .GASPRICE => some 1
    | .EXTCODESIZE  => some 1
    | .EXTCODECOPY => some 0
    | .RETURNDATASIZE  => some 1
    | .RETURNDATACOPY => some 0
    | .EXTCODEHASH => some 1
    | .BLOCKHASH => some 1
    | .COINBASE => some 1
    | .TIMESTAMP => some 1
    | .NUMBER => some 1
    | .PREVRANDAO => some 1
    | .DIFFICULTY => some 1
    | .GASLIMIT => some 1
    | .CHAINID => some 1
    | .SELFBALANCE => some 1
    | .BASEFEE => some 1
    | .POP => some 0
    | .MLOAD => some 1
    | .MSTORE => some 0
    | .MSTORE8 => some 0
    | .SLOAD => some 1
    | .SSTORE => some 0
    | .PC => some 1
    | .MSIZE => some 1
    | .GAS => some 1
    | .JUMP => some 0
    | .JUMPI => some 0
    | .JUMPDEST => some 0
    | .TLOAD => some 1
    | .TSTORE => some 0
    | .MCOPY => some 0
    | .Push _ => some 1
    | .DUP1 => some 2
    | .DUP2 => some 3
    | .DUP3 => some 4
    | .DUP4 => some 5
    | .DUP5 => some 6
    | .DUP6 => some 7
    | .DUP7 => some 8
    | .DUP8 => some 9
    | .DUP9 => some 10
    | .DUP10 => some 11
    | .DUP11 => some 12
    | .DUP12 => some 13
    | .DUP13 => some 14
    | .DUP14 => some 15
    | .DUP15 => some 16
    | .DUP16 => some 16
    | .SWAP1 => some 2
    | .SWAP2 => some 3
    | .SWAP3 => some 4
    | .SWAP4 => some 5
    | .SWAP5 => some 6
    | .SWAP6 => some 7
    | .SWAP7 => some 8
    | .SWAP8 => some 9
    | .SWAP9 => some 10
    | .SWAP10 => some 11
    | .SWAP11 => some 12
    | .SWAP12 => some 13
    | .SWAP13 => some 14
    | .SWAP14 => some 15
    | .SWAP15 => some 16
    | .SWAP16 => some 17
    | .Log _ => some 0
    | .CREATE => some 1
    | .CALL => some 1
    | .CALLCODE => some 1
    | .RETURN => some 0
    | .DELEGATECALL => some 1
    | .CREATE2 => some 1
    | .STATICCALL => some 0
    | .REVERT => some 0
    | .INVALID => none
    | .SELFDESTRUCT => some 0

def parseInstr : UInt8 → Option (Operation .EVM)
  | 0 => some .STOP
  | 1 => some .ADD
  | 2 => some .MUL
  | 3 => some .SUB
  | 4 => some .DIV
  | 5 => some .SDIV
  | 6 => some .MOD
  | 7 => some .SMOD
  | 8 => some .ADDMOD
  | 9 => some .MULMOD
  | 10 => some .EXP
  | 11 => some .SIGNEXTEND
  | 16 => some .LT
  | 17 => some .GT
  | 18 => some .SLT
  | 19 => some .SGT
  | 20 => some .EQ
  | 21 => some .ISZERO
  | 22 => some .AND
  | 23 => some .OR
  | 24 => some .XOR
  | 25 => some .NOT
  | 26 => some .BYTE
  | 27 => some .SHL
  | 28 => some .SHR
  | 29 => some .SAR
  | 32 => some .KECCAK256
  | 48 => some .ADDRESS
  | 49 => some .BALANCE
  | 50 => some .ORIGIN
  | 51 => some .CALLER
  | 52 => some .CALLVALUE
  | 53 => some .CALLDATALOAD
  | 54 => some .CALLDATASIZE
  | 55 => some .CALLDATACOPY
  | 56 => some .CODESIZE
  | 57 => some .CODECOPY
  | 58 => some .GASPRICE
  | 59 => some .EXTCODESIZE
  | 60 => some .EXTCODECOPY
  | 61 => some .RETURNDATASIZE
  | 62 => some .RETURNDATACOPY
  | 63 => some .EXTCODEHASH
  | 64 => some .BLOCKHASH
  | 65 => some .COINBASE
  | 66 => some .TIMESTAMP
  | 67 => some .NUMBER
  | 68 => some .DIFFICULTY
  | 69 => some .GASLIMIT
  | 70 => some .CHAINID
  | 71 => some .SELFBALANCE
  | 72 => some .BASEFEE
  | 80 => some .POP
  | 81 => some .MLOAD
  | 82 => some .MSTORE
  | 83 => some .MSTORE8
  | 84 => some .SLOAD
  | 85 => some .SSTORE
  | 86 => some .JUMP
  | 87 => some .JUMPI
  | 88 => some .PC
  | 89 => some .MSIZE
  | 90 => some .GAS
  | 91 => some .JUMPDEST
  | 92 => some .TLOAD
  | 93 => some .TSTORE
  | 94 => some .MCOPY
  | 95 => some .PUSH0
  | 96 => some .PUSH1
  | 97 => some .PUSH2
  | 98 => some .PUSH3
  | 99 => some .PUSH4
  | 100 => some .PUSH5
  | 101 => some .PUSH6
  | 102 => some .PUSH7
  | 103 => some .PUSH8
  | 104 => some .PUSH9
  | 105 => some .PUSH10
  | 106 => some .PUSH11
  | 107 => some .PUSH12
  | 108 => some .PUSH13
  | 109 => some .PUSH14
  | 110 => some .PUSH15
  | 111 => some .PUSH16
  | 112 => some .PUSH17
  | 113 => some .PUSH18
  | 114 => some .PUSH19
  | 115 => some .PUSH20
  | 116 => some .PUSH21
  | 117 => some .PUSH22
  | 118 => some .PUSH23
  | 119 => some .PUSH24
  | 120 => some .PUSH25
  | 121 => some .PUSH26
  | 122 => some .PUSH27
  | 123 => some .PUSH28
  | 124 => some .PUSH29
  | 125 => some .PUSH30
  | 126 => some .PUSH31
  | 127 => some .PUSH32
  | 128 => some .DUP1
  | 129 => some .DUP2
  | 130 => some .DUP3
  | 131 => some .DUP4
  | 132 => some .DUP5
  | 133 => some .DUP6
  | 134 => some .DUP7
  | 135 => some .DUP8
  | 136 => some .DUP9
  | 137 => some .DUP10
  | 138 => some .DUP11
  | 139 => some .DUP12
  | 140 => some .DUP13
  | 141 => some .DUP14
  | 142 => some .DUP15
  | 143 => some .DUP16
  | 144 => some .SWAP1
  | 145 => some .SWAP2
  | 146 => some .SWAP3
  | 147 => some .SWAP4
  | 148 => some .SWAP5
  | 149 => some .SWAP6
  | 150 => some .SWAP7
  | 151 => some .SWAP8
  | 152 => some .SWAP9
  | 153 => some .SWAP10
  | 154 => some .SWAP11
  | 155 => some .SWAP12
  | 156 => some .SWAP13
  | 157 => some .SWAP14
  | 158 => some .SWAP15
  | 159 => some .SWAP16
  | 160 => some .LOG0
  | 161 => some .LOG1
  | 162 => some .LOG2
  | 163 => some .LOG3
  | 164 => some .LOG4
  | 240 => some .CREATE
  | 241 => some .CALL
  | 242 => some .CALLCODE
  | 243 => some .RETURN
  | 244 => some .DELEGATECALL
  | 245 => some .CREATE2
  | 250 => some .STATICCALL
  | 253 => some .REVERT
  | 254 => some .INVALID
  | 255 => some .SELFDESTRUCT
  | _   => none

end EVM

end EvmYul
